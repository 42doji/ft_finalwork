<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>블록체인 데이터 관리</title>
    <style>
        body { font-family: sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: auto; }
        .section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;}
        h1, h2 { color: #333; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], textarea {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;
        }
        button {
            padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;
        }
        button:hover { background-color: #0056b3; }
        #status, #resultArea {
            margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 4px;
            background-color: #e9ecef; word-break: break-all;
        }
        #resultArea pre { background-color: #fff; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>블록체인 데이터 관리</h1>

        <div id="status">상태 메시지가 여기에 표시됩니다...</div>

        <div class="section">
            <h2>새 JSON 문자열 기록 저장</h2>
            <label for="newJsonString">저장할 JSON 문자열:</label>
            <textarea id="newJsonString" rows="5" placeholder='예: {"name":"Alice", "value":100}'></textarea>
            <button id="saveNewJsonButton">새 기록 저장 및 확인</button>
        </div>

        <div class="section">
            <h2>인덱스로 JSON 기록 조회</h2>
            <label for="jsonIndex">조회할 인덱스:</label>
            <input type="number" id="jsonIndex" placeholder="예: 0">
            <button id="getJsonByIndexButton">인덱스로 조회</button>
        </div>

        <div class="section">
            <h2>최신 JSON 기록 조회</h2>
            <button id="getLatestJsonButton">최신 기록 조회</button>
        </div>

        <div id="resultArea">
            </div>
    </div>

    <script>
        // --- 설정 ---
        const BACKEND_API_BASE_URL = 'http://172.20.208.1:3000'; // 실제 백엔드 서버 주소로 변경하세요
        const ESTIMATED_MINING_TIME_MS = 10000; // 10초 (Fuji 테스트넷 상황에 따라 조절)

        // --- DOM 요소 ---
        const newJsonStringInput = document.getElementById('newJsonString');
        const saveNewJsonButton = document.getElementById('saveNewJsonButton');
        const jsonIndexInput = document.getElementById('jsonIndex');
        const getJsonByIndexButton = document.getElementById('getJsonByIndexButton');
        const getLatestJsonButton = document.getElementById('getLatestJsonButton');
        const statusDiv = document.getElementById('status');
        const resultAreaDiv = document.getElementById('resultArea');

        // --- 유틸리티 함수 ---
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function updateStatus(message, isError = false) {
            console.log(`UI Status: ${message}`);
            statusDiv.innerHTML = message;
            statusDiv.className = isError ? 'error' : '';
        }

        function displayResult(action, dataObject) {
            let content = `<h3>${action} 결과:</h3>`;
            if (dataObject === null || dataObject === undefined) {
                content += "<p>데이터가 없거나 조회에 실패했습니다.</p>";
            } else if (typeof dataObject === 'string') {
                 // Attempt to parse if it's a JSON string for pretty printing
                try {
                    const parsed = JSON.parse(dataObject);
                    content += `<pre>${JSON.stringify(parsed, null, 2)}</pre>`;
                } catch (e) {
                    // If not a JSON string, display as is
                    content += `<pre>${dataObject}</pre>`;
                }
            }
            else {
                content += `<pre>${JSON.stringify(dataObject, null, 2)}</pre>`;
            }
            resultAreaDiv.innerHTML = content;
        }


        // --- API 호출 함수들 ---
        async function callAddJsonStringAPI(stringToStore) {
            updateStatus('백엔드에 새 문자열 기록 요청 중...');
            try {
                const response = await fetch(`${BACKEND_API_BASE_URL}/jsons`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jsonString: stringToStore }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`JSON 추가 실패 (서버): ${errorData.details || response.statusText}`);
                }
                const result = await response.json(); // { message, transactionHash }
                updateStatus(`트랜잭션 전송 완료: ${result.transactionHash}. 블록체인 처리를 기다립니다...`);
                return result;
            } catch (error) {
                console.error('callAddJsonStringAPI 오류:', error);
                updateStatus(`JSON 추가 API 호출 오류: ${error.message}`, true);
                throw error;
            }
        }

        async function callGetJsonCountAPI() {
            updateStatus('저장된 총 데이터 개수 조회 중...');
            try {
                const response = await fetch(`${BACKEND_API_BASE_URL}/jsons/count`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`JSON 개수 조회 실패 (서버): ${errorData.details || response.statusText}`);
                }
                const result = await response.json(); // { count }
                updateStatus(`현재 총 ${result.count}개의 기록이 있습니다.`);
                return result.count;
            } catch (error) {
                console.error('callGetJsonCountAPI 오류:', error);
                updateStatus(`JSON 개수 API 호출 오류: ${error.message}`, true);
                throw error;
            }
        }

        async function callGetJsonByIndexAPI(index) {
            updateStatus(`인덱스 ${index}의 데이터 조회 중...`);
            try {
                const response = await fetch(`${BACKEND_API_BASE_URL}/jsons/${index}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 404) {
                        throw new Error(`인덱스 ${index}에서 JSON을 찾을 수 없습니다 (서버): ${errorData.error || ''}`);
                    }
                    throw new Error(`인덱스 ${index}의 JSON 조회 실패 (서버): ${errorData.details || response.statusText}`);
                }
                const result = await response.json(); // { index, jsonString }
                updateStatus(`인덱스 ${index}의 데이터 조회 성공!`);
                return result.jsonString; // JSON 문자열 반환
            } catch (error) {
                console.error('callGetJsonByIndexAPI 오류:', error);
                updateStatus(`인덱스 ${index} 조회 API 호출 오류: ${error.message}`, true);
                throw error;
            }
        }

        // --- 기능별 핸들러 함수 ---

        // 1. 새 기록 저장 및 확인
        async function handleSaveNewJson() {
            const stringToStore = newJsonStringInput.value.trim();
            if (!stringToStore) {
                updateStatus('저장할 JSON 문자열을 입력하세요.', true);
                return;
            }
            // 입력된 문자열이 유효한 JSON인지 간단히 확인 (선택 사항이지만 권장)
            try {
                JSON.parse(stringToStore);
            } catch (e) {
                updateStatus('입력한 문자열이 유효한 JSON 형식이 아닙니다. 확인해주세요.', true);
                return;
            }

            resultAreaDiv.innerHTML = ''; // 이전 결과 초기화
            try {
                await callAddJsonStringAPI(stringToStore);
                
                updateStatus(`약 ${ESTIMATED_MINING_TIME_MS / 1000}초간 트랜잭션 처리를 기다립니다...`);
                await delay(ESTIMATED_MINING_TIME_MS);

                updateStatus('방금 저장된 최신 기록을 조회합니다...');
                await handleGetLatestJson(true); // 저장 후 최신 기록 표시 (isAfterSave 플래그 전달)

            } catch (error) {
                // 오류는 각 API 호출 함수 내부 또는 여기서 처리됨
                updateStatus(`새 기록 저장 중 오류 발생: ${error.message}`, true);
                displayResult("새 기록 저장 실패", null);
            }
        }

        // 2. 인덱스로 조회
        async function handleGetJsonByIndex() {
            const indexStr = jsonIndexInput.value.trim();
            if (indexStr === '') {
                updateStatus('조회할 인덱스를 입력하세요.', true);
                return;
            }
            const index = parseInt(indexStr, 10);
            if (isNaN(index) || index < 0) {
                updateStatus('유효한 음이 아닌 정수 인덱스를 입력하세요.', true);
                return;
            }
            
            resultAreaDiv.innerHTML = ''; // 이전 결과 초기화
            try {
                const jsonString = await callGetJsonByIndexAPI(index);
                displayResult(`인덱스 ${index} 기록`, jsonString);
            } catch (error) {
                updateStatus(`인덱스 ${index} 조회 중 오류: ${error.message}`, true);
                displayResult(`인덱스 ${index} 기록 조회 실패`, null);
            }
        }

        // 3. 최신 기록 조회
        async function handleGetLatestJson(isAfterSave = false) {
            if (!isAfterSave) { // 일반적인 최신 기록 조회 시에만 결과 초기화
                 resultAreaDiv.innerHTML = '';
            }
            try {
                const count = await callGetJsonCountAPI();
                if (count === 0) {
                    updateStatus('저장된 기록이 없습니다.');
                    displayResult("최신 기록", null);
                    return;
                }
                const latestIndex = count - 1;
                const jsonString = await callGetJsonByIndexAPI(latestIndex);
                displayResult(`최신 기록 (인덱스: ${latestIndex})`, jsonString);
            } catch (error) {
                updateStatus(`최신 기록 조회 중 오류: ${error.message}`, true);
                displayResult("최신 기록 조회 실패", null);
            }
        }

        // --- 이벤트 리스너 ---
        saveNewJsonButton.addEventListener('click', handleSaveNewJson);
        getJsonByIndexButton.addEventListener('click', handleGetJsonByIndex);
        getLatestJsonButton.addEventListener('click', () => handleGetLatestJson(false));

        // 초기 상태 메시지
        updateStatus("페이지 로드 완료. 작업을 선택하세요.");
    </script>
</body>
</html>
